{callsFromEntryPoint:[],currentLevel:null,keccak:[],calls:[],logs:[],debug:[],lastOp:"",lastThreeOpcodes:[],stopCollectingTopic:"bb47ee3e183a558b1a2ff0874b079f3fc5478b7454eacf2bfc5af2ff5878f972",stopCollecting:!1,topLevelCallCounter:0,fault(t,e){this.debug.push("fault depth=",t.getDepth()," gas=",t.getGas()," cost=",t.getCost()," err=",t.getError())},result(t,e){return{callsFromEntryPoint:this.callsFromEntryPoint,keccak:this.keccak,logs:this.logs,calls:this.calls,debug:this.debug}},enter(t){!this.stopCollecting&&this.calls.push({type:t.getType(),from:toHex(t.getFrom()),to:toHex(t.getTo()),method:toHex(t.getInput()).slice(0,10),gas:t.getGas(),value:t.getValue()})},exit(t){!this.stopCollecting&&this.calls.push({type:null!=t.getError()?"REVERT":"RETURN",gasUsed:t.getGasUsed(),data:toHex(t.getOutput()).slice(0,4e3)})},countSlot(t,e){var s;t[e]=(null!==(s=t[e])&&void 0!==s?s:0)+1},step(t,e){var s;if(this.stopCollecting)return;let l=t.op.toString(),o=t.stack.length(),c=[];for(let i=0;i<3&&i<o;i++)c.push(t.stack.peek(i));if(this.lastThreeOpcodes.push({opcode:l,stackTop3:c}),this.lastThreeOpcodes.length>3&&this.lastThreeOpcodes.shift(),t.getGas()<t.getCost()&&(this.currentLevel.oog=!0),"REVERT"===l||"RETURN"===l){if(1===t.getDepth()){let r=parseInt(t.stack.peek(0).toString()),a=parseInt(t.stack.peek(1).toString()),n=toHex(t.memory.slice(r,r+a)).slice(0,4e3);this.calls.push({type:l,gasUsed:0,data:n})}this.lastThreeOpcodes=[]}if(1===t.getDepth()){if("CALL"===l||"STATICCALL"===l){let h=toAddress(t.stack.peek(1).toString(16)),p=toHex(h),u=parseInt(t.stack.peek(3).toString()),g=toHex(t.memory.slice(u,u+4));this.currentLevel=this.callsFromEntryPoint[this.topLevelCallCounter]={topLevelMethodSig:g,topLevelTargetAddress:p,access:{},opcodes:{},extCodeAccessInfo:{},contractSize:{}},this.topLevelCallCounter++}else if("LOG1"===l){let S=t.stack.peek(2).toString(16);S===this.stopCollectingTopic&&(this.stopCollecting=!0)}this.lastOp="";return}let d=this.lastThreeOpcodes[this.lastThreeOpcodes.length-2];if((null===(s=null==d?void 0:d.opcode)||void 0===s?void 0:s.match(/^(EXT.*)$/))!=null){let k=toAddress(d.stackTop3[0].toString(16)),L=toHex(k),$=this.lastThreeOpcodes.map(t=>t.opcode).join(" ");null==$.match(/^(\w+) EXTCODESIZE ISZERO$/)&&(this.currentLevel.extCodeAccessInfo[L]=l)}if(null!=l.match(/^(EXT.*|CALL|CALLCODE|DELEGATECALL|STATICCALL)$/)){let C=l.startsWith("EXT")?0:1,T=toAddress(t.stack.peek(C).toString(16)),f=toHex(T);null!=this.currentLevel.contractSize[f]||(t=>{let e=toHex(t),s=parseInt(e);return s>0&&s<10})(T)||(this.currentLevel.contractSize[f]={contractSize:e.getCode(T).length,opcode:l})}if("GAS"!==this.lastOp||l.includes("CALL")||this.countSlot(this.currentLevel.opcodes,"GAS"),"GAS"!==l&&null==l.match(/^(DUP\d+|PUSH\d+|SWAP\d+|POP|ADD|SUB|MUL|DIV|EQ|LTE?|S?GTE?|SLT|SH[LR]|AND|OR|NOT|ISZERO)$/)&&this.countSlot(this.currentLevel.opcodes,l),this.lastOp=l,"SLOAD"===l||"SSTORE"===l){let E=toWord(t.stack.peek(0).toString(16)),O=toHex(E),A=t.contract.getAddress(),_=toHex(A),m=this.currentLevel.access[_];null==m&&(m={reads:{},writes:{}},this.currentLevel.access[_]=m),"SLOAD"===l?null==m.reads[O]&&null==m.writes[O]&&(m.reads[O]=toHex(e.getState(A,E))):this.countSlot(m.writes,O)}if("KECCAK256"===l){let v=parseInt(t.stack.peek(0).toString()),D=parseInt(t.stack.peek(1).toString());D>20&&D<512&&this.keccak.push(toHex(t.memory.slice(v,v+D)))}else if(l.startsWith("LOG")){let R=parseInt(l.substring(3)),b=parseInt(t.stack.peek(0).toString()),y=parseInt(t.stack.peek(1).toString()),G=[];for(let I=0;I<R;I++)G.push("0x"+t.stack.peek(2+I).toString(16));let P=toHex(t.memory.slice(b,b+y));this.logs.push({topics:G,data:P})}}}